# Generated by Ansible - do not edit manually
services:
  db:
    container_name: &pgcontainer {{ compose_db_container_name }}
    image: postgres:17
    restart: unless-stopped
    environment:
      PGUSER: &pguser {{ db_username }}
      POSTGRES_USER: *pguser
      POSTGRES_PASSWORD_FILE: /run/secrets/db-password
      POSTGRES_DB: &pgdb {{ db_name }}
    volumes:
      - db:/var/lib/postgresql/data
    networks:
      - db
    secrets:
      - source: db-password
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -d {{ db_name }}" ]
      interval: 30s
      timeout: 3s
      retries: 5
      start_period: 10s

  frontend:
    container_name: frontend
    image: ghcr.io/ff-sued/dhs-frontend:{{ version }}
    restart: always
    networks:
      - app-network

  backend:
    container_name: backend
    image: ghcr.io/ff-sued/dhs-backend:{{ version }}
    restart: always
    depends_on:
      db:
        condition: service_healthy
        restart: true
    networks:
      - app-network
      - db
    secrets:
      # all secrets are placed in /var/secrets/<name> (e.g. /var/secrets/db-password)
      - source: db-password
      - source: jwt-public-key
      - source: jwt-private-key
    environment:
      DOMAIN: {{ vault_domain }}
      DB_HOST: *pgcontainer
      DB_PORT: 5432
      DB_DB: *pgdb
      DB_USER: *pguser
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s

  gatus:
    image: twinproduction/gatus:latest
    container_name: gatus
    volumes:
      - ./gatus.yaml:/config/config.yaml
    restart: always
    cap_add:
      # for ICMP monitoring
      - NET_RAW
    networks:
      - app-network
      - db

  caddy:
    build:
      dockerfile_inline: |
        FROM caddy:2
        COPY <<EOF /etc/caddy/Caddyfile
        {{ vault_domain }} {
          reverse_proxy /api/* backend:8080
          reverse_proxy /actuator/* backend:8080
          reverse_proxy /* frontend:3000
        }

        monitoring.{{ vault_domain }} {
          reverse_proxy gatus:8080
        }
        EOF
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - frontend
      - backend
    networks:
      - app-network

secrets:
  db-password:
    file: ./secrets/dbpass
  jwt-private-key:
    file: ./secrets/jwt
  jwt-public-key:
    file: ./secrets/jwt.pub
networks:
  app-network:
  db:
volumes:
  caddy_data:
  caddy_config:
  db:
